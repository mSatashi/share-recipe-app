{% block scripts %}
<script>
// Simple password strength checker and UI
function evaluatePassword(pw) {
const recommendations = [];
let score = 0;

if (!pw || pw.length === 0) return {score: 0, recommendations: ["Enter a password"]};

// length
if (pw.length >= 8) score += 1; else recommendations.push('Make it at least 8 characters long');
if (pw.length >= 12) score += 1;

// variety
if (/[a-z]/.test(pw)) score += 1; else recommendations.push('Add lowercase letters');
if (/[A-Z]/.test(pw)) score += 1; else recommendations.push('Add uppercase letters');
if (/[0-9]/.test(pw)) score += 1; else recommendations.push('Add digits');
if (/[^A-Za-z0-9]/.test(pw)) score += 1; else recommendations.push('Add special characters (e.g. !@#$%)');

// penalize common patterns
const lower = pw.toLowerCase();
const common = ['password','1234','qwerty','admin','letmein','iloveyou'];
if (common.some(c => lower.includes(c))) {
    recommendations.push('Avoid common words or sequences');
    score = Math.max(1, score - 2);
}

// Normalize score to 0..4
let normalized = Math.max(0, Math.min(4, Math.floor(score/1.5)));
return {score: normalized, recommendations: recommendations};
}

function updateStrengthUI() {
const pw = document.getElementById('password').value || '';
const res = evaluatePassword(pw);
const bar = document.getElementById('pw-strength-bar');
const label = document.getElementById('pw-strength-label');
const recCount = document.getElementById('pw-recommendation-count');

const percent = (res.score / 4) * 100;
bar.style.width = percent + '%';
bar.className = 'progress-bar';

if (res.score <= 1) {
    bar.classList.add('bg-danger');
    label.textContent = 'Very weak';
} else if (res.score === 2) {
    bar.classList.add('bg-warning');
    label.textContent = 'Weak';
} else if (res.score === 3) {
    bar.classList.add('bg-info');
    label.textContent = 'Good';
} else {
    bar.classList.add('bg-success');
    label.textContent = 'Strong';
}

const recLen = res.recommendations.length;
recCount.textContent = recLen ? recLen + ' recommendation(s)' : '';

// Store last result for modal
window.__pwLast = res;
}

function showStrengthModal() {
const res = window.__pwLast || evaluatePassword(document.getElementById('password').value || '');
const modalBody = document.getElementById('pw-strength-modal-body');
let html = '<p><strong>Strength:</strong> ' + (res.score >= 3 ? 'Good/Strong' : res.score === 2 ? 'Weak' : 'Very weak') + '</p>';
if (res.recommendations && res.recommendations.length) {
    html += '<p>Recommendations:</p><ul>' + res.recommendations.map(r => '<li>' + r + '</li>').join('') + '</ul>';
} else {
    html += '<p>No recommendations â€” this looks strong.</p>';
}
modalBody.innerHTML = html;
let modal = new bootstrap.Modal(document.getElementById('pw-strength-modal'));
modal.show();
}

function generatePassword() {
const length = 16;
const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{}<>?';
let pw = '';
const cryptoObj = window.crypto || window.msCrypto;
if (cryptoObj && cryptoObj.getRandomValues) {
    const values = new Uint32Array(length);
    cryptoObj.getRandomValues(values);
    for (let i = 0; i < length; i++) {
        pw += charset[values[i] % charset.length];
    }
} else {
    for (let i = 0; i < length; i++) pw += charset[Math.floor(Math.random() * charset.length)];
}
document.getElementById('password').value = pw;
document.getElementById('confirm_password').value = pw;
updateStrengthUI();
showStrengthModal();
}

document.addEventListener('DOMContentLoaded', function(){
const pw = document.getElementById('password');
const gen = document.getElementById('generatePassword');
const toggle = document.getElementById('togglePwVis');

pw.addEventListener('input', updateStrengthUI);
pw.addEventListener('blur', function(){ if (pw.value) showStrengthModal(); });
gen.addEventListener('click', generatePassword);
toggle.addEventListener('click', function(){
    if (pw.type === 'password') { pw.type = 'text'; toggle.textContent = 'Hide'; }
    else { pw.type = 'password'; toggle.textContent = 'Show'; }
});

// initial update
updateStrengthUI();
});
</script>

<!-- Modal -->
<div class="modal fade" id="pw-strength-modal" tabindex="-1" aria-labelledby="pwStrengthModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="pwStrengthModalLabel">Password Strength</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body" id="pw-strength-modal-body">
    <!-- Filled by JS -->
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    <button type="button" class="btn btn-primary" id="pw-apply-btn" data-bs-dismiss="modal">OK</button>
  </div>
</div>
</div>
</div>

{% endblock %}